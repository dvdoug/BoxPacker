group: travis_latest
language: php
sudo: false

env:
  - TEST_SUITE=unit
  - TEST_SUITE=functional
  - TEST_SUITE=efficiency
php:
  - 7.2
  - 7.1
  - 7.0
  - 5.6
  - 5.5
  - 5.4
  - nightly

matrix:
  include:
    - php: hhvm
      sudo: required
      services:
        - docker
  allow_failures:
    - php: nightly

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/.cache/composer

install:
  - |
    if [ "$TRAVIS_PHP_VERSION" = "hhvm" ]; then
      docker pull hhvm/hhvm:latest;
      docker run hhvm/hhvm:latest hhvm --version;
      docker run --name hhvmapt hhvm/hhvm:latest bash -c "apt update -y; apt install -y dialog apt-utils wget curl git";
      docker commit hhvmapt dvdoug/hhvm:apt;
      docker run --name hhvmcomposer dvdoug/hhvm:apt bash -c "/usr/bin/curl https://getcomposer.org/installer | hhvm -d hhvm.php7.all=1 --php -- /dev/stdin --install-dir=/usr/local/bin --filename=composer";
      docker commit hhvmcomposer dvdoug/hhvm:composer;
    else
      phpenv config-rm xdebug.ini || true;
    fi;
 - |
    if [ "$TRAVIS_PHP_VERSION" = "hhvm" ]; then
      docker run -v $(pwd):/var/source dvdoug/hhvm:composer hhvm -d hhvm.php7.all=1 /usr/local/bin/composer update --working-dir /var/source;
    else
      composer update;
    fi;

script:
- |
    if [ "$TRAVIS_PHP_VERSION" = "hhvm" ]; then
      docker run -v $(pwd):/var/source -w /var/source dvdoug/hhvm:composer hhvm -d hhvm.php7.all=1 /var/source/vendor/bin/phpunit;
    else
      php vendor/bin/phpunit;
      php vendor/bin/behat --strict;
    fi;


  - |
    if [ "${TEST_SUITE}" = "unit" ] && [ "$TRAVIS_PHP_VERSION" = "hhvm" ]; then
      docker run -v $(pwd):/var/source -w /var/source dvdoug/hhvm:composer hhvm -d hhvm.php7.all=1 /var/source/vendor/bin/phpunit --exclude-group efficiency;
    elif [ "${TEST_SUITE}" = "unit" ]; then
      php vendor/bin/phpunit --exclude-group efficiency;
    elif [ "${TEST_SUITE}" = "efficiency" ] && [ "$TRAVIS_PHP_VERSION" = "hhvm" ]; then
      docker run -v $(pwd):/var/source -w /var/source dvdoug/hhvm:composer hhvm -d hhvm.php7.all=1 /var/source/vendor/bin/phpunit --group efficiency;
    elif [ "${TEST_SUITE}" = "efficiency" ]; then
      php vendor/bin/phpunit --group efficiency;
    elif [ "${TEST_SUITE}" = "functional" ] && [ "$TRAVIS_PHP_VERSION" = "hhvm" ]; then
      docker run -v $(pwd):/var/source -w /var/source dvdoug/hhvm:composer hhvm -d hhvm.php7.all=1 /var/source/vendor/bin/behat --strict;
    elif [ "${TEST_SUITE}" = "functional" ]; then
      php vendor/bin/behat --strict;
    fi;